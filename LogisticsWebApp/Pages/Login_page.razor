@page "/login"
@using Blazored.LocalStorage
@using logistic_web.application.Helpers
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject SweetAlertService Swal
@inject JwtAuthService JwtService

@* @code {
   protected override async Task OnInitializedAsync()
    {
        // Kiểm tra nếu user đã đăng nhập (có token) thì redirect về dashboard
        var token = await LocalStorage.GetItemAsync<string>("token");
        if (!string.IsNullOrWhiteSpace(token))
        {
            Navigation.NavigateTo("/dashboard", true);
        }
    }
} *@

<div class="login-bg">
    <div class="login-form-container" style="width: 420px; max-width: 95vw; padding: 2.5rem 3rem 3rem 3rem;">
        <img src="LOGO-Logistics.png" alt="Logistics Logo" style="width:110px;display:block;margin:auto;margin-bottom:1rem;" />
        <h2 style="text-align:center;margin-bottom:1.5rem;font-weight:600; font-size: 1.5rem;">ĐĂNG NHẬP</h2>

        <EditForm Model="@employee" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <input class="form-control" style="height: 45px; font-size: 1rem; padding: 0.75rem 1rem;" @bind="employee.UsernameOrEmail" placeholder="Username" />
                <ValidationMessage For="@(() => employee.UsernameOrEmail)"/>
            </div>
            <div class="mb-3">
                <input type="password" class="form-control" style="height: 45px; font-size: 1rem; padding: 0.75rem 1rem;" @bind="employee.Password" placeholder="Password" />
                <ValidationMessage For="@(() => employee.Password)"/>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;margin-top:1rem;height:50px;font-size:1.05rem;font-weight:500; font-size: 1.2rem;">ĐĂNG NHẬP</button>
        </EditForm>
    </div>
</div>

@code {
    public UserLoginVM employee = new UserLoginVM();
    private HttpClient _httpClient;

 
    protected override void OnInitialized()
    {
        _httpClient = HttpClientFactory.CreateClient("LogisticApi");
    }


    private async Task HandleValidSubmit()
    {

        var response = await _httpClient.PostAsJsonAsync("user/login", employee);
        if (response.IsSuccessStatusCode)
        {
            //Lấy kết quả trả về từ api
            var result = await response.Content.ReadAsStringAsync();
            
            // Lưu token vào localStorage
            await LocalStorage.SetItemAsync("token", result);

            // Tạo tracking mới
            await _httpClient.PostAsJsonAsync("tracking/create", new { Username = employee.UsernameOrEmail, Action = "Đăng nhập thành công với username: " + employee.UsernameOrEmail });
            // Hiển thị thông báo thành công với SweetAlert2
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Thành công!",
                Text = "Đăng nhập thành công!",
                Icon = SweetAlertIcon.Success,
                Timer = 1500,
                ShowConfirmButton = false,
                TimerProgressBar = true
            });
            
            // Notify authentication state change
            if (AuthStateProvider is CustomAuthStateProvider customProvider)
            {
                customProvider.NotifyAuthStateChanged();
            }
            
           Navigation.NavigateTo(JwtService.GetHomePageByRole(result), true);

            
        }
        
        else
        {
            // Xem chi tiết lỗi
            var errorContent = await response.Content.ReadAsStringAsync();
            
            // Hiển thị thông báo lỗi với SweetAlert2
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Lỗi!",
                Text = "Đăng nhập thất bại! Vui lòng kiểm tra lại username và password.",
                Icon = SweetAlertIcon.Error,
                ConfirmButtonText = "Thử lại"
            });
        }
    }
}
