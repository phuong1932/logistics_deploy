@page "/edit-user/{id:int}"
@layout DashBoardLayout
@attribute [Authorize(Roles = "admin,staff")]
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorage
@using System.Text.Json
@using System.Text
@using Microsoft.AspNetCore.Authorization
@using LogisticsWebApp.DTO
@using Blazored.LocalStorage
@using logistic_web.application.Helpers
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject JwtAuthService JwtAuthService

<div class="container-fluid p-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit"></i> CHỈNH SỬA NGƯỜI DÙNG
                    </h4>
                    <button class="btn btn-light btn-sm" @onclick="GoBack">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>

                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                        </div>
                    }
                    else if (userModel == null)
                    {
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> Không tìm thấy thông tin người dùng.
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@userModel" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />

                            <div class="row">
                                <!-- Thông tin cơ bản -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Thông tin cơ bản</h5>
                                        </div>
                                        <div class="card-body">
                                           

                                            <!-- Username (readonly) -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    Tên đăng nhập
                                                </label>
                                                <input type="text" class="form-control" value="@userModel.Username" readonly  disabled/>
                                                <small class="text-muted">Tên đăng nhập không thể thay đổi</small>
                                            </div>

                                            <!-- Email -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    Email <span class="text-danger">*</span>
                                                </label>
                                                <InputText @bind-Value="userModel.Email" 
                                                           type="email"
                                                           class="form-control" 
                                                           placeholder="Nhập email" />
                                                <ValidationMessage For="@(() => userModel.Email)" class="text-danger" />
                                            </div>

                                            <!-- Full Name -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    Họ và tên <span class="text-danger">*</span>
                                                </label>
                                                <InputText @bind-Value="userModel.FullName" 
                                                           class="form-control" 
                                                           placeholder="Nhập họ và tên" />
                                                <ValidationMessage For="@(() => userModel.FullName)" class="text-danger" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Đổi mật khẩu -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="mb-0">Đổi mật khẩu (tùy chọn)</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info mb-3">
                                                <i class="fas fa-info-circle"></i> 
                                                Để trống nếu không muốn thay đổi mật khẩu
                                            </div>

                                            <!-- Password -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Mật khẩu mới</label>
                                                <div class="input-group">
                                                    <InputText @bind-Value="userModel.Password" 
                                                               type="@(showPassword ? "text" : "password")"
                                                               class="form-control" 
                                                               placeholder="Nhập mật khẩu mới" />
                                                    <button class="btn btn-outline-secondary" 
                                                            type="button" 
                                                            @onclick="TogglePasswordVisibility">
                                                        <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                                    </button>
                                                </div>
                                                <ValidationMessage For="@(() => userModel.Password)" class="text-danger" />
                                                <small class="text-muted">Tối thiểu 6 ký tự</small>
                                            </div>

                                            <!-- Confirm Password -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Xác nhận mật khẩu mới</label>
                                                <div class="input-group">
                                                    <InputText @bind-Value="userModel.ConfirmPassword" 
                                                               type="@(showConfirmPassword ? "text" : "password")"
                                                               class="form-control" 
                                                               placeholder="Nhập lại mật khẩu mới" />
                                                    <button class="btn btn-outline-secondary" 
                                                            type="button" 
                                                            @onclick="ToggleConfirmPasswordVisibility">
                                                        <i class="fas @(showConfirmPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                                    </button>
                                                </div>
                                                @if (!string.IsNullOrEmpty(userModel.Password) && 
                                                     !string.IsNullOrEmpty(userModel.ConfirmPassword) &&
                                                     userModel.Password != userModel.ConfirmPassword)
                                                {
                                                    <small class="text-danger">Mật khẩu xác nhận không khớp</small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quản lý vai trò -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">Quản lý vai trò</h5>
                                        </div>
                                        <div class="card-body">
                                         
                                           
                                               

                                                <!-- Select Role -->
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">
                                                        Vai trò <span class="text-danger">*</span>
                                                    </label>
                                                    <InputSelect @bind-Value="selectedRoleId" class="form-select form-select-lg">
                                                        <option value="0">-- Chọn vai trò --</option>
                                                        @foreach (var role in GetFilteredRoles())
                                                        {
                                                            <option value="@role.Id">
                                                                @role.RoleName
                                                                @(!string.IsNullOrEmpty(role.Description) ? $" - {role.Description}" : "")
                                                            </option>
                                                        }
                                                    </InputSelect>
                                                </div>

                                                @* Hiển thị select shipper khi chọn role shipper *@
                                                @if (selectedRoleId == 1002)
                                                {
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">
                                                            Chọn shipper liên kết <span class="text-danger">*</span>
                                                        </label>
                                                        <select class="form-select @(selectedShipperId == 0 ? "border-danger" : "")" @bind="selectedShipperId">
                                                            <option value="0">-- Chọn shipper --</option>
                                                            @if (listShippers != null && listShippers.Any())
                                                            {
                                                                @foreach (var shipper in listShippers)
                                                                {
                                                                    <option value="@shipper.Id">@shipper.TenTaiXe - @shipper.SoDienThoai</option>
                                                                }
                                                            }
                                                        </select>
                                                        <small class="text-danger fw-bold">Bắt buộc chọn shipper khi vai trò là Shipper</small>
                                                    </div>
                                                }

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Thông báo lỗi -->
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="fas fa-exclamation-circle"></i> @errorMessage
                                    <button type="button" class="btn-close" @onclick="ClearError"></button>
                                </div>
                            }

                            <!-- Thông báo thành công -->
                            @if (!string.IsNullOrEmpty(successMessage))
                            {
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="fas fa-check-circle"></i> @successMessage
                                    <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                                </div>
                            }

                            <!-- Buttons -->
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" class="btn btn-secondary" @onclick="GoBack">
                                    <i class="fas fa-times"></i> Hủy
                                </button>
                                <button type="submit" class="btn btn-warning" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Đang cập nhật...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-save"></i>
                                        <span>Cập nhật</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private UserUpdateModel? userModel;
    private List<RoleModel> availableRoles = new List<RoleModel>();
    private List<ShipperModel> listShippers = new List<ShipperModel>();
    private int selectedRoleId = 0;
    private int selectedShipperId = 0;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool showPassword = false;
    private string? currentUserRole = null;
    private bool showConfirmPassword = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        // Lấy role của user hiện tại
        var token = await LocalStorage.GetItemAsync<string>("token");
        if (!string.IsNullOrEmpty(token))
        {
           
                currentUserRole = JwtAuthService.GetRoleFromToken(token);
          
        }
        
        await LoadUserDetail();
        await LoadAvailableRoles();
        await LoadShippers();
    }

    private async Task LoadUserDetail()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var response = await client.GetAsync($"User/getuserbyid/{Id}");

            if (response.IsSuccessStatusCode)
            {
                
            var user = await response.Content.ReadFromJsonAsync<HTTPResponseVM<UserModel>>();

                if (user != null)
                {
                    userModel = new UserUpdateModel 
                    {
                        Id = user.Data.Id,
                        Username = user.Data.Username,
                        Email = user.Data.Email,
                        FullName = user.Data.FullName,
                    };
                }
            }
            else
            {
                errorMessage = "Không thể tải thông tin người dùng";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadAvailableRoles()
    {
       

            // Load all roles
            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var rolesResponse = await client.GetAsync("Role");
            if (rolesResponse.IsSuccessStatusCode)
            {
                var roles = await rolesResponse.Content.ReadFromJsonAsync<HTTPResponseVM<List<RoleModel>>>();

                if (roles != null)
                {
                    availableRoles = roles.Data.ToList();
                }
            }

            // Load user's current role
            var    userRoleResponse  = await client.GetAsync($"UserRole/GetUserRolesbyuserid/{Id}");

            if (userRoleResponse.IsSuccessStatusCode)
            {
              
                var userroles = await userRoleResponse.Content.ReadFromJsonAsync<HTTPResponseVM<List<UserRoleModel>>>();

                if (userroles != null)
                {
                    // Lấy role đầu tiên (giả sử mỗi user chỉ có 1 role chính)
                    
                    if (userroles != null && userroles.Data != null && userroles.Data.Any())
                    {
                        var userRole = userroles.Data.First();
                        selectedRoleId = userRole.RoleId;
                        selectedShipperId = userRole.ShipperId ?? 0;
                    }
                }
            }
    
    }

    private async Task LoadShippers()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var response = await client.GetAsync("Shipper/getallshippers");
            if (response.IsSuccessStatusCode)
            {
                var apiResult = await response.Content.ReadFromJsonAsync<HTTPResponseVM<List<ShipperModel>>>();
                if (apiResult != null && apiResult.Data != null)
                {
                    listShippers = apiResult.Data.ToList();
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading shippers: {ex.Message}");
        }
    }

    private List<RoleModel> GetFilteredRoles()
    {
        if (string.IsNullOrEmpty(currentUserRole))
        {
            return availableRoles;
        }

        var roleLower = currentUserRole.ToLower();
        
        // Nếu là admin: hiển thị tất cả roles
        if (roleLower == "admin")
        {
            return availableRoles;
        }
        
        // Nếu là staff: chỉ hiển thị role shipper
        if (roleLower == "staff")
        {
            return availableRoles.Where(r => r.RoleName.ToLower() == "shipper").ToList();
        }

        // Mặc định: trả về tất cả
        return availableRoles;
    }
            


    private async Task HandleSubmit()
    {
        try
        {
            // Validate password confirmation
            if (!string.IsNullOrEmpty(userModel!.Password))
            {
                if (userModel.Password != userModel.ConfirmPassword)
                {
                    errorMessage = "Mật khẩu xác nhận không khớp";
                    return;
                }
            }

            // Validate: Nếu chọn role shipper thì phải chọn shipper
            if (selectedRoleId == 1002 && (selectedShipperId == 0 || selectedShipperId == null))
            {
                errorMessage = "Vui lòng chọn shipper liên kết khi chọn vai trò Shipper";
                return;
            }

            isSubmitting = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            // 1. Update user basic info
            var updateRequest = new
            {
                fullName = userModel.FullName,
                email = userModel.Email,
                password = string.IsNullOrEmpty(userModel.Password) ? null : userModel.Password
            };

            var json = JsonSerializer.Serialize(updateRequest);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var response = await client.PutAsync($"User/updateuser/{Id}", content);
            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Cập nhật thông tin thất bại: {errorContent}";
                return;
            }

            // 2. Update role và shipper
            var updateRoleRequest = new 
            { 
                roleId = selectedRoleId,
                shipperId = selectedRoleId == 1002 && selectedShipperId > 0 ? (int?)selectedShipperId : null
            };
            var updateJson = JsonSerializer.Serialize(updateRoleRequest);
            var updateContent = new StringContent(updateJson, Encoding.UTF8, "application/json");
            
            var updateResponse = await client.PutAsync($"UserRole/update/{Id}", updateContent);
            if (!updateResponse.IsSuccessStatusCode)
            {
                var errorContent = await updateResponse.Content.ReadAsStringAsync();
                errorMessage = $"Cập nhật vai trò thất bại: {errorContent}";
                return;
            }
            // Tạo tracking mới
            var username = CustomAuthStateProvider.UserNameLoginCurrent;
            await client.PostAsJsonAsync("tracking/create", new { Username = username, Action = "Cập nhật người dùng thành công với id: " + Id });
            successMessage = "Cập nhật thành công! Đang chuyển hướng...";
            StateHasChanged();

            await Task.Delay(1500);
            NavigationManager.NavigateTo("/user-list");
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    private void ClearSuccess()
    {
        successMessage = null;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/user-list");
    }

}

