@page "/create-user"
@layout DashBoardLayout
@attribute [Authorize(Roles = "admin,staff")]
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorage
@using System.Text.Json
@using System.Text
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using LogisticsWebApp.DTO
@using Blazored.LocalStorage
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject JwtAuthService JwtAuthService
<div class="container-fluid p-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus"></i> THÊM MỚI NGƯỜI DÙNG
                    </h4>
                    <button class="btn btn-light btn-sm" @onclick="GoBack">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>

                <div class="card-body">
                    <EditForm Model="@userModel" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <!-- Tên đăng nhập -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    Tên đăng nhập <span class="text-danger">*</span>
                                </label>
                                <InputText @bind-Value="userModel.Username" class="form-control"
                                    placeholder="Nhập tên đăng nhập" />
                                <ValidationMessage For="@(() => userModel.Username)" class="text-danger mt-2" />
                            </div>

                            <!-- Email -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    Email <span class="text-danger">*</span>
                                </label>
                                <InputText @bind-Value="userModel.Email" type="email" class="form-control"
                                    placeholder="Nhập email" />
                                <ValidationMessage For="@(() => userModel.Email)" class="text-danger mt-2" />
                            </div>

                            <!-- Họ và tên -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">
                                    Họ và tên <span class="text-danger">*</span>
                                </label>
                                <InputText @bind-Value="userModel.FullName" class="form-control"
                                    placeholder="Nhập họ và tên đầy đủ" />
                                <ValidationMessage For="@(() => userModel.FullName)" class="text-danger mt-2" />
                            </div>

                            <!-- Mật khẩu -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    Mật khẩu <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <InputText @bind-Value="userModel.Password"
                                        type="@(showPassword ? "text" : "password")" class="form-control"
                                        placeholder="Nhập mật khẩu" />
                                    <button class="btn btn-outline-secondary" type="button"
                                        @onclick="TogglePasswordVisibility">
                                        <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => userModel.Password)" class="text-danger mt-2" />
                            </div>

                            <!-- Xác nhận mật khẩu -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    Xác nhận mật khẩu <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <InputText @bind-Value="userModel.ConfirmPassword"
                                        type="@(showConfirmPassword ? "text" : "password")" class="form-control"
                                        placeholder="Nhập lại mật khẩu" />
                                    <button class="btn btn-outline-secondary" type="button"
                                        @onclick="ToggleConfirmPasswordVisibility">
                                        <i class="fas @(showConfirmPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => userModel.ConfirmPassword)" class="text-danger mt-2" />
                            </div>

                            <!-- Vai trò -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">
                                    Vai trò <span class="text-danger">*</span>
                                </label>
                                <div class="alert alert-info mb-2">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Mặc định:</strong> Người dùng mới sẽ được gán vai trò <span
                                        class="badge bg-primary">User</span>
                                </div>
                                <select @bind="userModel.RoleId" class="form-select">
                                    <option value="0" Selected>User (Mặc định)</option>
                                    <option value="1002">shipper</option>
                                </select>
                                <small class="text-muted">
                                    Bạn có thể thay đổi vai trò sau khi tạo tài khoản trong phần "Quản lý vai trò"
                                </small>
                            </div>

                            @if (userModel.RoleId == 1002)
                            {
                                <div class="col-md-12 mb-3">
                                    <label class="form-label mt-2 fw-bold">
                                        Chọn shipper liên kết <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" @bind="userModel.ShipperId">
                                        <option value="0">-- Chọn shipper --</option>
                                        @if (listShippers != null && listShippers.Any())
                                        {
                                            @foreach (var shipper in listShippers)
                                            {
                                                <option value="@shipper.Id">@shipper.TenTaiXe - @shipper.SoDienThoai</option>
                                            }
                                        }
                                    </select>
                                    <small class="text-muted">Bắt buộc chọn shipper khi vai trò là Shipper</small>
                                </div>
                            }
                        </div>

                        <!-- Thông báo lỗi -->
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle"></i> @errorMessage
                                <button type="button" class="btn-close" @onclick="ClearError"></button>
                            </div>
                        }

                        <!-- Thông báo thành công -->
                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle"></i> @successMessage
                                <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                            </div>
                        }

                        <!-- Buttons -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-secondary" @onclick="ResetForm">
                                <i class="fas fa-redo"></i> Làm mới
                            </button>
                            <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"
                                        aria-hidden="true"></span>
                                    <span>Đang tạo...</span>
                                }
                                else
                                {
                                    <i class="fas fa-save"></i>
                                    <span>Tạo tài khoản</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            <!-- Hướng dẫn -->
            <div class="card shadow mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Lưu ý
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Tên đăng nhập phải có ít nhất 3 ký tự và không được trùng với tài khoản đã có</li>
                        <li>Email phải hợp lệ và chưa được sử dụng</li>
                        <li>Mật khẩu phải có ít nhất 6 ký tự và nên kết hợp chữ hoa, chữ thường, số và ký tự đặc biệt
                        </li>
                        <li>Tất cả người dùng mới sẽ được tự động gán vai trò <strong>User</strong></li>
                        <li>Bạn có thể thêm hoặc thay đổi vai trò cho người dùng sau khi tạo tài khoản</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserRegisterModel userModel = new UserRegisterModel();
    private List<RoleModel> availableRoles = new List<RoleModel>();
    private string? currentUserRole = null;
    private bool isSubmitting = false;
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private string? errorMessage;
    private string? successMessage;

    private List<ShipperModel> listShippers = new();

    protected override async Task OnInitializedAsync()
    {
            // Lấy role của user hiện tại
        var token = await LocalStorage.GetItemAsync<string>("token");
        if (!string.IsNullOrEmpty(token))
        {
           
                currentUserRole = JwtAuthService.GetRoleFromToken(token);
          
        }
        await LoadShippers();
        await LoadAvailableRoles();

    }

    private async Task LoadShippers()
    {

        var client = HttpClientFactory.CreateClient("LogisticApi");
        var token = await LocalStorage.GetItemAsync<string>("token");
        if (!string.IsNullOrEmpty(token))
        {
            client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }
        var response = await client.GetAsync("Shipper/getallshippers");
        if (response.IsSuccessStatusCode)
        {
            var apiResult = await response.Content.ReadFromJsonAsync<HTTPResponseVM<List<ShipperModel>>>();

            listShippers = apiResult.Data.ToList();

        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    private void ClearSuccess()
    {
        successMessage = null;
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            // Validate: Nếu chọn role shipper thì phải chọn shipper
            if (userModel.RoleId == 1002 && (userModel.ShipperId == null || userModel.ShipperId == 0))
            {
                errorMessage = "Vui lòng chọn shipper liên kết khi chọn vai trò Shipper";
                isSubmitting = false;
                StateHasChanged();
                return;
            }

            var json = JsonSerializer.Serialize(userModel);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var response = await client.PostAsync("User/register", content);
            var responseContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                // Tạo tracking mới
                var username = CustomAuthStateProvider.UserNameLoginCurrent;
                await client.PostAsJsonAsync("tracking/create", new { Username = username, Action = "Tạo người dùng thành công: " + userModel.Username });
                successMessage = "Tạo tài khoản thành công! Đang chuyển hướng...";
                StateHasChanged();

                await Task.Delay(1500);
                NavigationManager.NavigateTo("/user-list");
            }
            else
            {
                // Parse error message
                try
                {
                    var errorResponse = JsonSerializer.Deserialize<JsonElement>(responseContent);
                    if (errorResponse.TryGetProperty("message", out var messageProperty))
                    {
                        errorMessage = messageProperty.GetString();
                    }
                    else
                    {
                        errorMessage = "Tạo tài khoản thất bại. Vui lòng kiểm tra lại thông tin.";
                    }
                }
                catch
                {
                    errorMessage = "Tạo tài khoản thất bại. Vui lòng kiểm tra lại thông tin.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
     private async Task LoadAvailableRoles()
    {
       

            // Load all roles
            var client = HttpClientFactory.CreateClient("LogisticApi");
            var token = await LocalStorage.GetItemAsync<string>("token");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            var rolesResponse = await client.GetAsync("Role");
            if (rolesResponse.IsSuccessStatusCode)
            {
                var roles = await rolesResponse.Content.ReadFromJsonAsync<HTTPResponseVM<List<RoleModel>>>();

                if (roles != null)
                {
                    availableRoles = roles.Data.ToList();
                }
            }

    
    }
    private List<RoleModel> GetFilteredRoles()
    {
        if (string.IsNullOrEmpty(currentUserRole))
        {
            return availableRoles;
        }

        var roleLower = currentUserRole.ToLower();
        
        // Nếu là admin: hiển thị tất cả roles
        if (roleLower == "admin")
        {
            return availableRoles;
        }
        
        // Nếu là staff: chỉ hiển thị role shipper
        if (roleLower == "staff")
        {
            return availableRoles.Where(r => r.RoleName.ToLower() == "shipper").ToList();
        }

        // Mặc định: trả về tất cả
        return availableRoles;
    }
    private void ResetForm()
    {
        userModel = new UserRegisterModel();
        errorMessage = null;
        successMessage = null;
        showPassword = false;
        showConfirmPassword = false;
        StateHasChanged();
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/user-list");
    }
}
