@page "/Storage_data"
@layout DashBoardLayout
@attribute [Authorize(Roles = "admin,user,staff")]
@inject IJSRuntime JSRuntime
@using System.IO
@using System.Linq



<div class="container-fluid">
    <div class="row">
        <div class="col-4 file-explorer">
            <h3>My Files</h3>
            
            <!-- Hi·ªÉn th·ªã path hi·ªán t·∫°i -->
            <div style="margin-bottom: 10px;">
                @if (currentPath.Count > 0)
                {
                    <small class="text-muted">Path: @string.Join(" / ", currentPath)</small>
                }
            </div>
            
            <!-- C√°c n√∫t ƒëi·ªÅu khi·ªÉn -->
            <div class="header-actions" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                @if (currentPath.Count > 0)
                {
                    <button class="btn btn-sm btn-secondary" @onclick="GoBack">‚Üê Back</button>
                }
                <button class="btn btn-sm btn-info" @onclick="RefreshCargoDirectories">üîÑ Refresh All</button>
                @* <button class="btn btn-sm btn-success" @onclick="CreateNewFolder">üìÅ New Folder</button>
                <button class="btn btn-sm btn-primary" @onclick="CreateNewFile">üìÑ New File</button> *@
            </div>

            <div class="section mt-4">
                <h4>Folders</h4>

                <div class="grid">
                    @foreach (var folder in Folders)
                    {
                        <div class="folder-card @(selectedFolder == folder.Name ? "selected" : "")" 
                             style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;"
                             @onclick="() => HandleItemClick(folder)"
                             @ondblclick="() => HandleItemDoubleClick(folder)">
                            <div class="folder-icon">
                                @if (folder.Type == "Folder")
                                {
                                    <span>üìÅ</span>
                                }
                                else
                                {
                                    <span>üìÑ</span>
                                }
                            </div>
                            <div class="folder-name">@folder.Name</div>
                        </div>
                    }
                </div>

            </div>

            <div class="section mt-5">
                <h4>Files</h4>
                <div class="grid">
                    @foreach (var file in Files)
                    {
                        <div class="file-card">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-name">@file.Name</div>

                        </div>
                    }
                </div>
            </div>

            <div class="footer">
                <span>File Browser 2.21</span>
                <div class="footer-help">
                    <span>Help</span>
                </div>
            </div>

        </div>

        <div class="col-8">
            <table class="table table-striped">
                <thead>
                    <tr>
                            <th scope="col">#</th>
                            <th scope="col">T√™n file</th>
                            <th scope="col">Ng√†y t·∫°o</th>
                            <th scope="col">Ng∆∞·ªùi t·∫°o</th>
                            <th scope="col">K√≠ch th∆∞·ªõc</th>
                            <th scope="col">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    @if (selectedFolderFiles != null && selectedFolderFiles.Any())
                    {
                        @for (int i = 0; i < selectedFolderFiles.Count; i++)
                        {
                            var file = selectedFolderFiles[i];
                            <tr>
                                <th scope="row">@(i + 1)</th>
                                <td>
                                    @if (file.Type == "Folder")
                                    {
                                        <span>üìÅ</span> @file.Name
                                    }
                                    else
                                    {
                                        <span>üìÑ</span> @file.Name
                                    }
                                </td>
                                <td>@GetTimeAgo(file.LastModified)</td>
                                <td>@file.Creator</td>
                                <td>@(file.Size ?? "-")</td>
                                <td>
                                    @if (file.Type == "Folder")
                                    {
                                        <button class="btn btn-sm btn-info" @onclick="() => OpenSubFolder(file.Name)">Open</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick="() => DownloadFile(file)">Download</button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteFile(file)">Delete</button>
                                        <button class="btn btn-sm btn-success" @onclick="() => ShowFileData(file)">Show data</button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center">Ch·ªçn m·ªôt th∆∞ m·ª•c ƒë·ªÉ xem c√°c file b√™n trong</td>
                        </tr>
                    }
                </tbody>
            
            
            </table>
        </div>
    </div>

</div>

@* Modal hi·ªÉn th·ªã JSON data *@
@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h5>üìÑ @selectedFileName</h5>
                <button class="btn-close-custom" @onclick="CloseModal">‚úï</button>
            </div>
            <div class="modal-body-custom">
                @if (cargoData != null)
                {
                    <div class="cargo-info">
                        <!-- Metadata Section -->
                        <div class="info-section">
                            <h6 class="section-title">üìã Th√¥ng tin chung</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">M√£ ƒë∆°n h√†ng:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "cargoCode")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ng√†y t·∫°o:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "dates", "createdAt")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ng∆∞·ªùi t·∫°o:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "employeeCreate")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Info -->
                        <div class="info-section">
                            <h6 class="section-title">üë§ Th√¥ng tin kh√°ch h√†ng</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">T√™n kh√°ch h√†ng:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "customerCompanyName")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ng∆∞·ªùi ph·ª• tr√°ch:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "customerPersonInCharge")</span>
                                </div>
                                <div class="info-item full-width">
                                    <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "customerAddress")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Service Info -->
                        <div class="info-section">
                            <h6 class="section-title">üöö Th√¥ng tin d·ªãch v·ª•</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Lo·∫°i d·ªãch v·ª•:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "serviceType", "name") (@GetJsonValue(cargoData, "cargoInfo", "serviceType", "code"))</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">S·ªë l∆∞·ª£ng shipper:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "logistics", "quantityOfShipper")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Info -->
                        <div class="info-section">
                            <h6 class="section-title">üí∞ Th√¥ng tin t√†i ch√≠nh</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">T·ªïng ti·ªÅn d·ª± ki·∫øn:</span>
                                    <span class="info-value highlight">@GetJsonValue(cargoData, "cargoInfo", "financial", "estimatedTotalAmountFormatted")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ti·ªÅn ƒë·∫∑t c·ªçc:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "financial", "advanceMoneyFormatted")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "financial", "shippingFeeFormatted")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="info-section">
                            <h6 class="section-title">üìÖ Ng√†y quan tr·ªçng</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Ng√†y c·∫•p ph√©p:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "dates", "licenseDate")</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ng√†y trao ƒë·ªïi:</span>
                                    <span class="info-value">@GetJsonValue(cargoData, "cargoInfo", "dates", "exchangeDate")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (!string.IsNullOrEmpty(fileJsonContent))
                {
                    <p class="text-center text-danger">@fileJsonContent</p>
                }
                else
                {
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>
                }
            </div>
            <div class="modal-footer-custom">
                <button class="btn btn-secondary" @onclick="CloseModal">ƒê√≥ng</button>
                <button class="btn btn-primary" @onclick="DownloadCurrentFile">Download</button>
            </div>
        </div>
    </div>
}

<style>
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-dialog-custom {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        width: 90%;
        max-width: 800px;
    }

    .modal-content-custom {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header-custom {
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header-custom h5 {
        margin: 0;
        font-size: 1.25rem;
    }

    .btn-close-custom {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        transition: color 0.2s;
    }

    .btn-close-custom:hover {
        color: #000;
    }

    .modal-body-custom {
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
    }

    .modal-footer-custom {
        padding: 15px 20px;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* Cargo Info Styles */
    .cargo-info {
        padding: 10px;
    }

    .info-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
        font-size: 1rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-item.full-width {
        grid-column: 1 / -1;
    }

    .info-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }

    .info-value {
        font-size: 0.95rem;
        color: #212529;
        font-weight: 400;
        word-break: break-word;
    }

    .info-value.highlight {
        color: #28a745;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

@* code ket qua click *@

@code
{
    private string? selectedFolder = null;
    private List<FileItem>? selectedFolderFiles = null;
    private bool isDoubleClicking = false;
    
    // Modal state
    private bool showModal = false;
    private string selectedFileName = "";
    private string fileJsonContent = "";
    private FileItem? currentFileForDownload = null;
    private System.Text.Json.JsonElement? cargoData = null;



    private void CreateNewFolder()
    {
        // TODO: Implement create new folder logic
        Console.WriteLine("Create new folder clicked");
    }

    private void CreateNewFile()
    {
        // TODO: Implement create new file logic
        Console.WriteLine("Create new file clicked");
    }

    private void HandleItemClick(FileItem item)
    {
        // Ch·ªâ x·ª≠ l√Ω n·∫øu l√† folder
        if (item.Type == "Folder")
        {
            SelectFolder(item.Name);
        }
        else
        {
            // N·∫øu l√† file, hi·ªÉn th·ªã data
            ShowFileData(item);
        }
    }

    private void HandleItemDoubleClick(FileItem item)
    {
        // Ch·ªâ x·ª≠ l√Ω n·∫øu l√† folder
        if (item.Type == "Folder")
        {
            DoubleClickFolder(item.Name);
        }
        else
        {
            // N·∫øu l√† file, download ho·∫∑c m·ªü
            DownloadFile(item);
        }
    }

    private void SelectFolder(string folderName)
    {
        // N·∫øu ƒëang double click, b·ªè qua single click event
        if (isDoubleClicking)
        {
            return;
        }
        
        selectedFolder = folderName;
        
        // Ki·ªÉm tra xem folder n√†y c√≥ trong folderContents kh√¥ng (l√† root folder)
        if (folderContents.ContainsKey(folderName))
        {
            // Root folder - reset path
            currentPath.Clear();
            currentPath.Add(folderName);
            
            // Ch·ªâ l·∫•y c√°c folder, kh√¥ng l·∫•y file
            selectedFolderFiles = folderContents[folderName]
                .Where(item => item.Type == "Folder")
                .ToList();
            
            Console.WriteLine($"Single click ROOT folder: {folderName}, showing {selectedFolderFiles.Count} folders only");
        }
        else
        {
            // Sub folder - th√™m v√†o path (kh√¥ng reset)
            if (!currentPath.Contains(folderName))
            {
                currentPath.Add(folderName);
            }
            
            // Load t·ª´ file system
            LoadFolderContent(folderName);
            
            Console.WriteLine($"Single click SUB folder: {folderName}, path: {string.Join(" -> ", currentPath)}");
        }
        
        StateHasChanged();
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} ph√∫t tr∆∞·ªõc";
        else if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} gi·ªù tr∆∞·ªõc";
        else if (timeSpan.TotalDays < 30)
            return $"{(int)timeSpan.TotalDays} ng√†y tr∆∞·ªõc";
        else if (timeSpan.TotalDays < 365)
            return $"{(int)(timeSpan.TotalDays / 30)} th√°ng tr∆∞·ªõc";
        else
            return $"{(int)(timeSpan.TotalDays / 365)} nƒÉm tr∆∞·ªõc";
    }

    private void DownloadFile(FileItem file)
    {
        // Implement download logic
        Console.WriteLine($"Downloading file: {file.Name}");
    }

    private List<FileItem> Folders = new List<FileItem>();
    private List<FileItem> Files = new List<FileItem>();
    private Dictionary<string, List<FileItem>> folderContents = new Dictionary<string, List<FileItem>>();
    private List<string> currentPath = new List<string>();

    protected override void OnInitialized()
    {
        LoadAllCargoDirectories();
    }

    private void LoadAllCargoDirectories()
    {
        string cargoPath = Path.Combine("wwwroot", "cargo");
        
        if (Directory.Exists(cargoPath))
        {
            // L·∫•y t·∫•t c·∫£ th∆∞ m·ª•c con trong cargo
            var directories = Directory.GetDirectories(cargoPath);
            
            Folders.Clear();
            folderContents.Clear();
            
            // Th√™m t·∫•t c·∫£ th∆∞ m·ª•c v√†o danh s√°ch
            foreach (var dirPath in directories)
            {
                var dirInfo = new DirectoryInfo(dirPath);
                string folderName = dirInfo.Name;
                string displayName = GetDisplayName(folderName);
                
                // Th√™m th∆∞ m·ª•c ch√≠nh
                Folders.Add(new FileItem 
                { 
                    Name = displayName, 
                    Type = "Folder", 
                    LastModified = dirInfo.LastWriteTime 
                });
                
                // L·∫•y t·∫•t c·∫£ th∆∞ m·ª•c con trong th∆∞ m·ª•c n√†y
                var subDirectories = Directory.GetDirectories(dirPath);
                var allFiles = new List<FileItem>();
                
                // Th√™m th∆∞ m·ª•c con v√†o danh s√°ch
                foreach (var subDirPath in subDirectories)
                {
                    var subDirInfo = new DirectoryInfo(subDirPath);
                    allFiles.Add(new FileItem
                    {
                        Name = subDirInfo.Name,
                        Type = "Folder",
                        LastModified = subDirInfo.LastWriteTime,
                        Creator = "System"
                    });
                }
                
                // L·∫•y t·∫•t c·∫£ file JSON trong th∆∞ m·ª•c n√†y (bao g·ªìm c·∫£ th∆∞ m·ª•c con)
                var jsonFiles = Directory.GetFiles(dirPath, "*.json", SearchOption.AllDirectories);
                
                foreach (var filePath in jsonFiles)
                {
                    var fileInfo = new FileInfo(filePath);
                    allFiles.Add(new FileItem
                    {
                        Name = Path.GetFileName(filePath),
                        Type = "File",
                        LastModified = fileInfo.LastWriteTime,
                        Size = FormatFileSize(fileInfo.Length),
                        Creator = "System"
                    });
                }
                
                folderContents[displayName] = allFiles;
            }
        }
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024:F1} KB";
        return $"{bytes / (1024 * 1024):F1} MB";
    }

    private string GetDisplayName(string folderName)
    {
        return folderName switch
        {
            "cargo_list" => "L·ªãch s·ª≠ ƒë∆°n h√†ng",
            "cargo_history" => "L·ªãch s·ª≠ v·∫≠n chuy·ªÉn",
            "cargo_archive" => "Kho l∆∞u tr·ªØ",
            "cargo_backup" => "Sao l∆∞u d·ªØ li·ªáu",
            _ => folderName // Gi·ªØ nguy√™n t√™n n·∫øu kh√¥ng c√≥ mapping
        };
    }

    private string GetOriginalName(string displayName)
    {
        return displayName switch
        {
            "L·ªãch s·ª≠ ƒë∆°n h√†ng" => "cargo_list",
            "L·ªãch s·ª≠ v·∫≠n chuy·ªÉn" => "cargo_history",
            "Kho l∆∞u tr·ªØ" => "cargo_archive",
            "Sao l∆∞u d·ªØ li·ªáu" => "cargo_backup",
            _ => displayName // Gi·ªØ nguy√™n t√™n n·∫øu kh√¥ng c√≥ mapping
        };
    }

    private void RefreshCargoDirectories()
    {
        LoadAllCargoDirectories();
        StateHasChanged();
    }

    private async void DoubleClickFolder(string folderName)
    {
        // Set flag ƒë·ªÉ ngƒÉn SelectFolder ch·∫°y
        isDoubleClicking = true;
        
        // N·∫øu ƒë√£ c√≥ trong path, kh√¥ng th√™m n·ªØa (tr√°nh duplicate)
        if (!currentPath.Contains(folderName))
        {
            currentPath.Add(folderName);
        }
        
        // Load n·ªôi dung th∆∞ m·ª•c cho c·∫£ b√™n tr√°i v√† b√™n ph·∫£i
        LoadFolderContentForBothSides(folderName);
        
        
        StateHasChanged();
        
        // Reset flag sau m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn
        await Task.Delay(300);
        isDoubleClicking = false;
    }

    private void GoBack()
    {
        if (currentPath.Count > 1)
        {
            currentPath.RemoveAt(currentPath.Count - 1);
            string parentFolder = currentPath.Last();
            
            // Load l·∫°i n·ªôi dung th∆∞ m·ª•c cha
            LoadFolderContentForBothSides(parentFolder);
            
            StateHasChanged();
        }
        else if (currentPath.Count == 1)
        {
            // Quay v·ªÅ root - x√≥a path v√† load l·∫°i t·∫•t c·∫£
            currentPath.Clear();
            LoadAllCargoDirectories();
            selectedFolderFiles = null; // X√≥a n·ªôi dung b√™n ph·∫£i
            
            StateHasChanged();
        }
    }

    private string GetCurrentPathDisplay()
    {
        if (currentPath.Count == 0) return "Root";
        return currentPath.Last();
    }

    private void LoadFolderContentForBothSides(string folderName)
    {
        if (currentPath.Count == 1)
        {
            // Th∆∞ m·ª•c g·ªëc - load t·ª´ folderContents
            if (folderContents.ContainsKey(folderName))
            {
                // C·∫≠p nh·∫≠t b√™n tr√°i v·ªõi th∆∞ m·ª•c con
                UpdateLeftSideFolders(folderName);
                
                // Debug: ki·ªÉm tra n·ªôi dung folderContents
                Console.WriteLine($"folderContents[{folderName}] has {folderContents[folderName].Count} items:");
                foreach (var item in folderContents[folderName])
                {
                    Console.WriteLine($"  - {item.Name} (Type: {item.Type})");
                }
                
                Console.WriteLine($"Folders after UpdateLeftSideFolders has {Folders.Count} items:");
                foreach (var folder in Folders)
                {
                    Console.WriteLine($"  - {folder.Name} (Type: {folder.Type})");
                }
                
                // C·∫≠p nh·∫≠t b√™n ph·∫£i v·ªõi n·ªôi dung gi·ªëng b√™n tr√°i
                selectedFolderFiles = new List<FileItem>(Folders);
                
                Console.WriteLine($"selectedFolderFiles has {selectedFolderFiles.Count} items:");
            }
        }
        else
        {
            // Th∆∞ m·ª•c con - load t·ª´ file system
            string fullPath = Path.Combine("wwwroot", "cargo", GetOriginalName(currentPath[0]));
            for (int i = 1; i < currentPath.Count; i++)
            {
                fullPath = Path.Combine(fullPath, currentPath[i]);
            }
            
            // Debug: ki·ªÉm tra ƒë∆∞·ªùng d·∫´n
            Console.WriteLine($"Loading from path: {Path.GetFullPath(fullPath)}");
            Console.WriteLine($"Directory exists: {Directory.Exists(fullPath)}");
            
            if (Directory.Exists(fullPath))
            {
                var allItems = new List<FileItem>();
                var newFolders = new List<FileItem>();
                
                // L·∫•y th∆∞ m·ª•c con
                var subDirs = Directory.GetDirectories(fullPath);
                Console.WriteLine($"Found {subDirs.Length} subdirectories");
                
                foreach (var dir in subDirs)
                {
                    var dirInfo = new DirectoryInfo(dir);
                    var folderItem = new FileItem
                    {
                        Name = dirInfo.Name,
                        Type = "Folder",
                        LastModified = dirInfo.LastWriteTime,
                        Creator = "System"
                    };
                    
                    allItems.Add(folderItem);
                    newFolders.Add(folderItem);
                }
                
                // L·∫•y file JSON
                var jsonFiles = Directory.GetFiles(fullPath, "*.json");
                Console.WriteLine($"Found {jsonFiles.Length} JSON files");
                
                foreach (var file in jsonFiles)
                {
                    var fileInfo = new FileInfo(file);
                    var fileItem = new FileItem
                    {
                        Name = Path.GetFileName(file),
                        Type = "File",
                        LastModified = fileInfo.LastWriteTime,
                        Size = FormatFileSize(fileInfo.Length),
                        Creator = "System"
                    };
                    
                    allItems.Add(fileItem);
                }
                
                // N·∫øu kh√¥ng c√≥ subfolder, hi·ªán file ·ªü b√™n tr√°i
                if (subDirs.Length == 0 && jsonFiles.Length > 0)
                {
                    Console.WriteLine("No subfolders found, showing files on left side");
                    Folders.Clear();
                    Folders.AddRange(allItems); // Hi·ªán file ·ªü b√™n tr√°i
                }
                else
                {
                    // C√≥ subfolder, ch·ªâ hi·ªán subfolder ·ªü b√™n tr√°i
                    Console.WriteLine("Subfolders found, showing only folders on left side");
                    Folders.Clear();
                    Folders.AddRange(newFolders);
                }
                
                // C·∫≠p nh·∫≠t b√™n ph·∫£i v·ªõi n·ªôi dung gi·ªëng b√™n tr√°i
                selectedFolderFiles = new List<FileItem>(Folders);
            }
        }
    }

    private void UpdateLeftSideFolders(string folderName)
    {
        // L·∫•y th∆∞ m·ª•c con t·ª´ folderContents
        if (folderContents.ContainsKey(folderName))
        {
            // L·∫•y ch·ªâ th∆∞ m·ª•c con (kh√¥ng l·∫•y file)
            var subFolders = folderContents[folderName]
                .Where(item => item.Type == "Folder")
                .ToList();
            
            // C·∫≠p nh·∫≠t Folders ƒë·ªÉ hi·ªÉn th·ªã b√™n tr√°i
            Folders.Clear();
            Folders.AddRange(subFolders);
            
            foreach (var folder in subFolders)
            {
                Console.WriteLine($"  - {folder.Name} (Type: {folder.Type})");
            }
        }
    }

    private void LoadFolderContent(string folderName)
    {
        if (currentPath.Count == 1)
        {
            // Th∆∞ m·ª•c g·ªëc - load t·ª´ folderContents
            if (folderContents.ContainsKey(folderName))
            {
                selectedFolderFiles = folderContents[folderName];
            }
        }
        else
        {
            // Th∆∞ m·ª•c con - load t·ª´ file system
            string fullPath = Path.Combine("wwwroot", "cargo", GetOriginalName(currentPath[0]));
            for (int i = 1; i < currentPath.Count; i++)
            {
                fullPath = Path.Combine(fullPath, currentPath[i]);
            }
            
            if (Directory.Exists(fullPath))
            {
                var allItems = new List<FileItem>();
                
                // L·∫•y th∆∞ m·ª•c con
                var subDirs = Directory.GetDirectories(fullPath);
                foreach (var dir in subDirs)
                {
                    var dirInfo = new DirectoryInfo(dir);
                    allItems.Add(new FileItem
                    {
                        Name = dirInfo.Name,
                        Type = "Folder",
                        LastModified = dirInfo.LastWriteTime,
                        Creator = "System"
                    });
                }
                
                // L·∫•y file JSON
                var jsonFiles = Directory.GetFiles(fullPath, "*.json");
                foreach (var file in jsonFiles)
                {
                    var fileInfo = new FileInfo(file);
                    allItems.Add(new FileItem
                    {
                        Name = Path.GetFileName(file),
                        Type = "File",
                        LastModified = fileInfo.LastWriteTime,
                        Size = FormatFileSize(fileInfo.Length),
                        Creator = "System"
                    });
                }
                
                selectedFolderFiles = allItems;
            }
        }
    }

    private void OpenSubFolder(string subFolderName)
    {
        // T√¨m th∆∞ m·ª•c con trong th∆∞ m·ª•c hi·ªán t·∫°i
        string currentPath = Path.Combine("wwwroot", "cargo", GetOriginalName(selectedFolder), subFolderName);
        
        if (Directory.Exists(currentPath))
        {
            var jsonFiles = Directory.GetFiles(currentPath, "*.json");
            var subFolderFiles = new List<FileItem>();
            
            foreach (var filePath in jsonFiles)
            {
                var fileInfo = new FileInfo(filePath);
                subFolderFiles.Add(new FileItem
                {
                    Name = Path.GetFileName(filePath),
                    Type = "File",
                    LastModified = fileInfo.LastWriteTime,
                    Size = FormatFileSize(fileInfo.Length),
                    Creator = "System"
                });
            }
            
            selectedFolderFiles = subFolderFiles;
            StateHasChanged();
        }
    }

    private void DeleteFile(FileItem file)
    {
        // Implement delete logic
        if (selectedFolderFiles != null)
        {
            selectedFolderFiles.Remove(file);
            StateHasChanged();
        }
    }

    private async void ShowFileData(FileItem file)
    {
        // Hi·ªÉn th·ªã th√¥ng tin file (kh√¥ng th√™m v√†o path)
        Console.WriteLine($"Showing data for file: {file.Name}");
        Console.WriteLine($"Current path (unchanged): {string.Join(" / ", currentPath)}");
        
        try
        {
            // Set file info
            selectedFileName = file.Name;
            currentFileForDownload = file;
            showModal = true;
            fileJsonContent = ""; // Reset content
            cargoData = null; // Reset cargo data
            StateHasChanged();
            
            // X√¢y d·ª±ng ƒë∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß ƒë·∫øn file
            string fullPath = Path.Combine("wwwroot", "cargo");
            
            Console.WriteLine($"=== DEBUG ShowFileData ===");
            Console.WriteLine($"currentPath count: {currentPath.Count}");
            Console.WriteLine($"currentPath: {string.Join(" / ", currentPath)}");
            
            if (currentPath.Count > 0)
            {
                // Th√™m c√°c th∆∞ m·ª•c trong path
                string originalName = GetOriginalName(currentPath[0]);
                Console.WriteLine($"Original name: {originalName}");
                fullPath = Path.Combine(fullPath, originalName);
                
                for (int i = 1; i < currentPath.Count; i++)
                {
                    Console.WriteLine($"Adding to path: {currentPath[i]}");
                    fullPath = Path.Combine(fullPath, currentPath[i]);
                }
            }
            
            fullPath = Path.Combine(fullPath, file.Name);
            
            Console.WriteLine($"Final path: {Path.GetFullPath(fullPath)}");
            Console.WriteLine($"File exists: {File.Exists(fullPath)}");
            
            // N·∫øu file kh√¥ng t·ªìn t·∫°i, th·ª≠ t√¨m trong t·∫•t c·∫£ th∆∞ m·ª•c con
            if (!File.Exists(fullPath))
            {
                string searchPath = Path.Combine("wwwroot", "cargo");
                var foundFiles = Directory.GetFiles(searchPath, file.Name, SearchOption.AllDirectories);
                
                if (foundFiles.Length > 0)
                {
                    fullPath = foundFiles[0];
                    Console.WriteLine($"Found file at: {fullPath}");
                }
            }
            
            // ƒê·ªçc n·ªôi dung file JSON
            if (File.Exists(fullPath))
            {
                string jsonContent = await File.ReadAllTextAsync(fullPath);
                
                // Parse JSON th√†nh object
                try
                {
                    var jsonDoc = System.Text.Json.JsonDocument.Parse(jsonContent);
                    cargoData = jsonDoc.RootElement;
                    
                    Console.WriteLine("JSON parsed successfully");
                }
                catch (Exception jsonEx)
                {
                    Console.WriteLine($"JSON parse error: {jsonEx.Message}");
                    fileJsonContent = $"‚ùå L·ªói parse JSON: {jsonEx.Message}";
                }
                
                StateHasChanged();
            }
            else
            {
                fileJsonContent = $"‚ùå File kh√¥ng t·ªìn t·∫°i: {Path.GetFullPath(fullPath)}";
                Console.WriteLine($"File not found: {Path.GetFullPath(fullPath)}");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reading file: {ex.Message}");
            fileJsonContent = $"‚ùå L·ªói khi ƒë·ªçc file: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private void CloseModal()
    {
        showModal = false;
        fileJsonContent = "";
        selectedFileName = "";
        currentFileForDownload = null;
        cargoData = null;
        StateHasChanged();
    }
    
    private void DownloadCurrentFile()
    {
        if (currentFileForDownload != null)
        {
            DownloadFile(currentFileForDownload);
        }
    }
    
    private string GetJsonValue(System.Text.Json.JsonElement? jsonElement, params string[] path)
    {
        try
        {
            if (jsonElement == null || !jsonElement.HasValue)
                return "-";
            
            var current = jsonElement.Value;
            
            foreach (var key in path)
            {
                if (current.ValueKind == System.Text.Json.JsonValueKind.Object && current.TryGetProperty(key, out var property))
                {
                    current = property;
                }
                else
                {
                    return "-";
                }
            }
            
            return current.ValueKind switch
            {
                System.Text.Json.JsonValueKind.String => current.GetString() ?? "-",
                System.Text.Json.JsonValueKind.Number => current.GetRawText(),
                System.Text.Json.JsonValueKind.True => "C√≥",
                System.Text.Json.JsonValueKind.False => "Kh√¥ng",
                System.Text.Json.JsonValueKind.Null => "-",
                _ => current.GetRawText()
            };
        }
        catch
        {
            return "-";
        }
    }
}